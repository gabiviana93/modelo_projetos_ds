name: CI - Teste e Validação

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-checks:
    name: Verificações de Qualidade
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Instalar Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Cache Poetry virtualenv
        uses: actions/cache@v3
        with:
          path: .venv
          key: ${{ runner.os }}-poetry-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-${{ matrix.python-version }}-
      
      - name: Instalar dependências
        run: poetry install --no-interaction --no-root
      
      - name: Verificar sintaxe Python
        run: |
          poetry run python -m py_compile src/*.py
          poetry run python -m py_compile tests/*.py
          poetry run python -m py_compile scripts/*.py
      
      - name: Validar imports
        run: |
          poetry run python -c "
          import sys
          import pathlib
          for py_file in pathlib.Path('src').glob('**/*.py'):
              if '__pycache__' not in str(py_file):
                  try:
                      with open(py_file) as f:
                          compile(f.read(), str(py_file), 'exec')
                  except SyntaxError as e:
                      print(f'Erro de sintaxe em {py_file}: {e}')
                      sys.exit(1)
          print('✅ Todos os arquivos Python têm sintaxe válida')
          "
      
      - name: Verificar linting com pylint
        continue-on-error: true
        run: |
          poetry run pylint src/ --fail-under=7.0 --disable=C0111,C0103,R0913,R0914 2>/dev/null || echo "Aviso: pylint não disponível"
      
      - name: Verificar estilo com flake8
        continue-on-error: true
        run: |
          poetry run flake8 src/ --max-line-length=100 --ignore=E203,W503 2>/dev/null || echo "Aviso: flake8 não disponível"

  unit-tests:
    name: Testes Unitários
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Instalar Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Cache Poetry virtualenv
        uses: actions/cache@v3
        with:
          path: .venv
          key: ${{ runner.os }}-poetry-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-${{ matrix.python-version }}-
      
      - name: Instalar dependências
        run: poetry install --no-interaction --no-root
      
      - name: Executar pytest
        run: |
          poetry run pytest tests/ -v --tb=short --cov=src --cov-report=xml --cov-report=html
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  pipeline-validation:
    name: Validação do Pipeline
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Instalar Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Cache Poetry virtualenv
        uses: actions/cache@v3
        with:
          path: .venv
          key: ${{ runner.os }}-poetry-pipeline-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-pipeline-
      
      - name: Instalar dependências
        run: poetry install --no-interaction --no-root
      
      - name: Gerar dados de teste
        run: |
          poetry run python generate_data.py
      
      - name: Executar pipeline completo
        run: |
          PYTHONPATH=/home/runner/work/modelo_projetos_ds/modelo_projetos_ds poetry run python scripts/run_pipeline.py
      
      - name: Validar outputs do pipeline
        run: |
          poetry run python -c "
          import json
          import pathlib
          
          # Verificar se relatórios foram gerados
          reports_dir = pathlib.Path('reports')
          assert reports_dir.exists(), 'Diretório reports não existe'
          
          # Verificar métricas
          metrics_file = reports_dir / 'metrics.json'
          assert metrics_file.exists(), 'Arquivo metrics.json não encontrado'
          
          with open(metrics_file) as f:
              metrics = json.load(f)
              required_keys = ['accuracy', 'f1_score', 'precision', 'recall']
              for key in required_keys:
                  assert key in metrics, f'Métrica {key} não encontrada'
          
          # Verificar dados processados
          data_file = pathlib.Path('data/processed/data.csv')
          assert data_file.exists(), 'Arquivo de dados processados não encontrado'
          
          print('✅ Pipeline validado com sucesso!')
          "

  monitoring-validation:
    name: Validação de Monitoramento
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Instalar Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Cache Poetry virtualenv
        uses: actions/cache@v3
        with:
          path: .venv
          key: ${{ runner.os }}-poetry-monitoring-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-monitoring-
      
      - name: Instalar dependências
        run: poetry install --no-interaction --no-root
      
      - name: Testar detecção de drift
        run: |
          poetry run python -c "
          import sys
          import pandas as pd
          import numpy as np
          from src.monitoring import population_stability_index, detect_drift
          
          # Gerar dados de teste sem drift
          np.random.seed(42)
          baseline = np.random.normal(loc=0, scale=1, size=1000)
          current = np.random.normal(loc=0, scale=1, size=1000)
          
          # Calcular PSI
          psi = population_stability_index(baseline, current)
          print(f'PSI (sem drift): {psi:.4f}')
          assert psi < 0.15, f'PSI muito alto para dados similares: {psi}'
          
          # Gerar dados com drift
          current_drift = np.random.normal(loc=1, scale=1, size=1000)
          psi_drift = population_stability_index(baseline, current_drift)
          print(f'PSI (com drift): {psi_drift:.4f}')
          
          print('✅ Detecção de drift validada!')
          "

  build-status:
    name: Status Final
    runs-on: ubuntu-latest
    needs: [quality-checks, unit-tests, pipeline-validation, monitoring-validation]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "================================"
          echo "✅ CI Pipeline Completado!"
          echo "================================"
          echo ""
          echo "Jobs executados:"
          echo "  ✓ Verificações de Qualidade"
          echo "  ✓ Testes Unitários"
          echo "  ✓ Validação do Pipeline"
          echo "  ✓ Validação de Monitoramento"
          echo ""
          echo "Para mais detalhes, veja os logs acima."
